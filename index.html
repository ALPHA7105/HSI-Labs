<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSI Labs: Ultra Dynamic Portal</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font family and custom styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.4s;
            scroll-behavior: smooth;
        }
        /* Custom scrollbar for visual appeal in dark theme */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #475569; /* Slate-600 */
            border-radius: 4px;
        }
        /* Utility for smooth fading elements */
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Modal background transition */
        .modal-bg {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content-slide {
            transition: transform 0.4s ease-out;
        }
        .card-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Dark Theme Palette
                        'background-dark': '#0f172a', // Very Dark Blue/Slate-900
                        'card-dark': '#1e293b', // Slate-800
                        'primary': '#6366f1', // Indigo-500 (Vibrant Accent)
                        'secondary-text': '#e2e8f0', // Slate-200
                        'tab-active-bg': '#334155', // Slate-700 for active tab
                        'delete-red': '#ef4444', // Red-500
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen bg-background-dark text-secondary-text">

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="pt-4 mb-8">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-white mb-2">
                <span class="text-primary">üß™ HSI Labs</span>: Dynamic Portal
            </h1>
            
            <!-- Tab Navigation -->
            <nav class="border-b border-slate-700 mt-4">
                <div class="flex space-x-4 overflow-x-auto pb-1">
                    <button id="tab-topics" data-target="lab-topics" class="tab-button px-6 py-3 text-lg font-semibold border-b-2 border-primary text-primary transition duration-200 bg-tab-active-bg rounded-t-lg shadow-inner whitespace-nowrap">
                        The Lab Topics
                    </button>
                    <button id="tab-submission" data-target="submission-hub" class="tab-button px-6 py-3 text-lg font-semibold border-b-2 border-transparent text-slate-400 hover:text-white hover:border-slate-500 transition duration-200 whitespace-nowrap">
                        Project Submission Hub
                    </button>
                </div>
            </nav>
        </header>

        <!-- --- 1. LAB TOPICS SECTION --- -->
        <div id="lab-topics" class="tab-content fade-in">
            <h2 class="text-3xl font-bold text-white mt-8 mb-4">
                Foundations of Scientific Inquiry
            </h2>
            <p class="text-slate-400 mb-6 max-w-4xl">
                Use the search and filters below to quickly find the foundational lab or advanced project you need.
            </p>

            <!-- Search and Filter Controls (Sticky for better navigation) -->
            <div class="bg-card-dark p-6 rounded-xl card-shadow mb-8 border border-slate-700 sticky top-0 z-10 transition duration-300">
                <input type="text" id="search-input" placeholder="Search by topic title or keywords (e.g., 'density', 'thermo', 'gas law')"
                       class="w-full px-5 py-3 bg-slate-900 border border-slate-700 rounded-lg focus:ring-primary focus:border-primary text-secondary-text placeholder-slate-500 text-lg transition duration-150 ease-in-out shadow-sm">

                <div class="mt-4 flex flex-wrap gap-3" id="category-filters">
                    <!-- Filter buttons will be injected here by JavaScript -->
                </div>
            </div>

            <!-- Topic Grid -->
            <div id="topics-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Topic cards will be injected here by JavaScript -->
            </div>

            <!-- No Results Message -->
            <div id="no-results" class="text-center py-12 text-slate-500 hidden bg-card-dark rounded-xl shadow-lg mt-8">
                <svg class="mx-auto h-12 w-12 text-slate-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h3 class="mt-2 text-xl font-medium">No Labs Found</h3>
                <p class="mt-1 text-base">Try adjusting your search or clearing the category filter.</p>
            </div>
            
            <!-- Loading Indicator (Hidden by default) -->
            <div id="loading-spinner" class="text-center py-12 hidden">
                <svg class="animate-spin h-10 w-10 text-primary mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="text-primary mt-3">Loading topics...</p>
            </div>
        </div>
        <!-- --------------------------------------------------- -->


        <!-- --- 2. SUBMISSION HUB SECTION --- -->
        <div id="submission-hub" class="tab-content hidden fade-in">
            <h2 class="text-3xl font-bold text-white mt-8 mb-4">
                üìÅ Project Submission Hub
            </h2>
            <p class="text-slate-400 mb-8 max-w-xl">
                Use the form below to upload your final work. A running list of your previous submissions is kept below.
            </p>
            
            <!-- UPLOAD INTERFACE -->
            <div class="p-8 bg-card-dark rounded-xl card-shadow border border-primary/30 mb-12">
                <h3 class="text-2xl text-primary font-semibold mb-4">Upload File</h3>
                <div class="flex flex-col md:flex-row gap-4">
                    <input type="text" id="project-name-input" placeholder="Enter Project Name (e.g., 'John Smith - Calorimetry Report')"
                           class="flex-grow px-5 py-3 bg-slate-900 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:ring-primary focus:border-primary transition duration-150 ease-in-out">
                    <input type="file" id="file-selector" class="hidden" onchange="displayFileName()">
                    <button onclick="document.getElementById('file-selector').click()"
                            class="md:w-auto w-full px-6 py-3 bg-slate-700 text-white font-bold rounded-lg hover:bg-slate-600 transition duration-200 shadow-md transform hover:scale-[1.01]">
                        Choose File
                    </button>
                    <button onclick="simulateUpload()"
                            class="md:w-auto w-full px-6 py-3 bg-primary text-slate-900 font-bold rounded-lg hover:bg-indigo-300 transition duration-200 shadow-lg hover:shadow-primary/50 transform hover:scale-[1.02]">
                        Submit Project
                    </button>
                </div>
                <div id="selected-file-name" class="mt-4 text-sm text-slate-500">No file selected.</div>
            </div>

            <!-- PREVIOUS SUBMISSIONS TABLE/LIST -->
            <h3 class="text-2xl font-bold text-white mb-4 border-b border-slate-700 pb-2">Your Previous Submissions (Simulated)</h3>
            <div id="submission-list" class="space-y-4">
                <!-- Submission items will be rendered here -->
            </div>
            
        </div>
        <!-- --------------------------------------------------- -->


        <!-- --- LESSON MODAL (THE FIX) --- -->
        <div id="lesson-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-bg opacity-0" onclick="closeModal()">
            <!-- Modal Backdrop -->
            <div class="absolute inset-0 bg-black bg-opacity-90"></div>
            
            <!-- Modal Content -->
            <div class="bg-card-dark rounded-xl shadow-2xl max-w-4xl w-full mx-4 h-[95vh] flex flex-col modal-content-slide transform translate-y-10 scale-95 transition duration-300 ease-out" 
                 onclick="event.stopPropagation()">
                
                <!-- Modal Header -->
                <div class="p-6 border-b border-slate-700 flex justify-between items-start flex-shrink-0">
                    <div class="pr-8">
                        <h3 id="modal-title" class="text-3xl sm:text-4xl font-extrabold text-primary">Lesson Title</h3>
                        <p id="modal-category" class="text-sm uppercase tracking-wider text-slate-400 mt-2 p-1 bg-slate-700/50 inline-block rounded-full px-3">Category</p>
                    </div>
                    <button onclick="closeModal()" class="text-slate-400 hover:text-white transition duration-200 p-2 rounded-full hover:bg-slate-700 flex-shrink-0">
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <!-- Modal Body (Scrollable) -->
                <div id="modal-content" class="p-6 flex-grow overflow-y-auto space-y-6 text-slate-300 text-lg leading-relaxed">
                    <!-- Lesson content will be dynamically loaded here -->
                    <!-- Content will be divided into sections (Objectives, Equipment, Procedure) -->
                </div>
                
                <!-- Modal Footer -->
                <div class="p-4 border-t border-slate-700 flex justify-between items-center flex-shrink-0">
                    <p class="text-sm text-slate-500">End of Lesson Materials</p>
                    <button onclick="closeModal()" class="px-8 py-3 bg-primary text-slate-900 font-bold rounded-lg hover:bg-indigo-300 transition duration-200 shadow-md">
                        Done Reading
                    </button>
                </div>
            </div>
        </div>


        <!-- Notification Message Box (Custom Alert) -->
        <div id="message-box" class="fixed top-4 right-4 bg-green-600 text-white p-4 rounded-lg shadow-xl hidden z-50 opacity-0 transition duration-300" role="alert">
            <p id="message-text" class="font-semibold"></p>
        </div>
    </div>

    <footer class="text-center p-4 mt-12 text-sm text-slate-500 border-t border-slate-700">
        &copy; 2025 HSI Labs Portal Ultra Edition.
    </footer>

    <script>
        // --- DATA SECTION: Over 70 topics for robust filtering and search testing. ---
        // I have added a new category "Atomic Structure" and the requested "Periodic Table Elements" lab (ID 71)
        // along with YouTube links from the search results.
        const labTopics = [
            { id: 1, title: "Density Determination", category: "Fundamentals", description: "Measuring mass and volume of solids and liquids to calculate density." },
            { id: 2, title: "Precision and Accuracy", category: "Fundamentals", description: "Practicing measurements and analyzing data for reliability and systematic error." },
            { id: 3, title: "Separation of Mixtures", category: "Fundamentals", description: "Using techniques like filtration, decantation, and evaporation to separate components." },
            { id: 4, title: "Paper Chromatography", category: "Fundamentals", description: "Separating dyes or pigments based on differential solubility and capillary action." },
            { id: 5, title: "Crystallization Techniques", category: "Fundamentals", description: "Growing pure solid crystals from a saturated solution." },
            { id: 6, title: "Flame Tests", category: "Fundamentals", description: "Identifying unknown metal ions based on the characteristic color of their emitted light." },
            { id: 7, title: "Physical vs. Chemical Change", category: "Fundamentals", description: "Observing and classifying reactions to distinguish between the two types of change." },
            { id: 8, title: "Sublimation", category: "Fundamentals", description: "Observing the solid-to-gas phase transition (e.g., using iodine or dry ice)." },
            { id: 9, title: "Percent Water in a Hydrate", category: "Fundamentals", description: "Heating a hydrated salt to determine the mass of water of crystallization." },
            { id: 10, title: "Law of Conservation of Mass", category: "Fundamentals", description: "Conducting a reaction in a closed system to prove mass is conserved." },

            { id: 11, title: "Synthesis Reaction", category: "Stoichiometry", description: "Creating a compound from its constituent elements (e.g., magnesium oxide)." },
            { id: 12, title: "Decomposition Reaction", category: "Stoichiometry", description: "Breaking down a compound into simpler substances (e.g., hydrogen peroxide)." },
            { id: 13, title: "Single Replacement Reaction", category: "Stoichiometry", description: "Observing reactions between metals and acids/salt solutions." },
            { id: 14, title: "Double Displacement/Precipitation", category: "Stoichiometry", description: "Mixing two soluble ionic compounds to form an insoluble precipitate." },
            { id: 15, title: "Determining Empirical Formula", category: "Stoichiometry", description: "Finding the simplest whole-number ratio of atoms in a compound." },
            { id: 16, title: "Limiting Reactant Determination", category: "Stoichiometry", description: "Using stoichiometry to identify and calculate the excess reactant." },
            { id: 17, title: "Percent Yield Calculation", category: "Stoichiometry", description: "Comparing theoretical yield to the actual mass of product obtained." },
            { id: 18, title: "Qualitative Analysis of Ions", category: "Stoichiometry", description: "Using a sequence of tests to identify unknown ions in a solution." },
            { id: 19, title: "Types of Chemical Reactions", category: "Stoichiometry", description: "Classifying reactions (acid-base, redox, precipitation) using net ionic equations." },
            { id: 20, title: "Molar Mass of a Gas", category: "Stoichiometry", description: "Using the Ideal Gas Law to experimentally determine the molar mass of an unknown volatile compound." },

            { id: 21, title: "Boyle's Law Verification", category: "Gases & Solutions", description: "Investigating the inverse relationship between gas pressure and volume." },
            { id: 22, title: "Charles's Law Verification", category: "Gases & Solutions", description: "Investigating the direct relationship between gas volume and temperature." },
            { id: 23, title: "Gas Collection Over Water", category: "Gases & Solutions", description: "Measuring the volume of gas produced in a reaction, accounting for vapor pressure." },
            { id: 24, title: "Preparing Standard Solutions", category: "Gases & Solutions", description: "Accurately making a solution of known molarity." },
            { id: 25, title: "Dilutions and Molarity", category: "Gases & Solutions", description: "Calculating and preparing solutions of lower concentration from stock solutions." },
            { id: 26, title: "Solubility Curves Experiment", category: "Gases & Solutions", description: "Determining the maximum amount of solute that dissolves at various temperatures." },
            { id: 27, title: "Factors Affecting Dissolution Rate", category: "Gases & Solutions", description: "Investigating how temperature, surface area, and stirring affect solubility rate." },
            { id: 28, title: "Freezing Point Depression", category: "Gases & Solutions", description: "Measuring the colligative property effect on the freezing point of a solvent." },
            { id: 29, title: "Conductivity of Solutions", category: "Gases & Solutions", description: "Testing various substances to classify them as strong, weak, or non-electrolytes." },
            { id: 30, title: "Spectrophotometry (Beer's Law)", category: "Gases & Solutions", description: "Using light absorption to determine the concentration of a colored solution." },
            
            { id: 31, title: "Specific Heat Determination", category: "Kinetics & Thermo", description: "Measuring the amount of heat needed to raise the temperature of a substance using calorimetry." },
            { id: 32, title: "Enthalpy of Neutralization", category: "Kinetics & Thermo", description: "Using a calorimeter to measure the heat released ($\Delta H$) during an acid-base reaction." },
            { id: 33, title: "Hess's Law Verification", category: "Kinetics & Thermo", description: "Combining reaction enthalpies to calculate the enthalpy of a third, related reaction." },
            { id: 34, title: "Heat of Fusion of Ice", category: "Kinetics & Thermo", description: "Measuring the energy absorbed during a phase change (melting)." },
            { id: 35, title: "Cooling Curves Analysis", category: "Kinetics & Thermo", description: "Graphing temperature vs. time for a cooling substance to find phase change plateaus." },
            { id: 36, title: "Factors Affecting Reaction Rate", category: "Kinetics & Thermo", description: "Investigating the effect of concentration, temperature, and surface area on reaction speed." },
            { id: 37, title: "Catalysis Demonstration", category: "Kinetics & Thermo", description: "Showing how a catalyst speeds up a reaction without being consumed (e.g., $\text{KI}$ on $\text{H}_2\text{O}_2$)." },
            { id: 38, title: "Reaction Order Determination", category: "Kinetics & Thermo", description: "Finding the rate law for a chemical reaction using initial rates data." },
            { id: 39, title: "Activation Energy Calculation", category: "Kinetics & Thermo", description: "Using the Arrhenius equation to calculate $E_a$ from temperature and rate data." },
            { id: 40, title: "Le Chatelier's Principle", category: "Kinetics & Thermo", description: "Observing shifts in equilibrium when stress is applied (concentration, temperature, pressure)." },

            { id: 41, title: "Acid-Base Titration", category: "Equilibrium & Acids", description: "Determining the unknown concentration of an acid or base solution." },
            { id: 42, title: "Indicator Selection", category: "Equilibrium & Acids", description: "Testing various indicators to find the best fit for different acid-base reactions." },
            { id: 43, title: "Buffer Preparation", category: "Equilibrium & Acids", description: "Creating a solution that resists changes in $\text{pH}$ upon addition of small amounts of acid or base." },
            { id: 44, title: "Buffer Capacity", category: "Equilibrium & Acids", description: "Measuring the amount of acid or base a buffer can absorb before its $\text{pH}$ changes significantly." },
            { id: 45, title: "Hydrolysis of Salts", category: "Equilibrium & Acids", description: "Testing the $\text{pH}$ of various salt solutions to determine if the ions hydrolyze water." },
            { id: 46, title: "Common Ion Effect", category: "Equilibrium & Acids", description: "Observing how adding a common ion affects the solubility of a sparingly soluble salt." },
            { id: 47, title: "Solubility Product Constant ($\text{K}_{sp}$)", category: "Equilibrium & Acids", description: "Experimentally determining the $\text{K}_{sp}$ value for a given salt." },
            { id: 48, title: "Redox Titration", category: "Equilibrium & Acids", description: "Using permanganate or other oxidizing agents to titrate a reducing agent." },
            { id: 49, title: "Electrolysis of Water", category: "Equilibrium & Acids", description: "Decomposing water into hydrogen and oxygen gases using electrical energy." },
            { id: 50, title: "Voltaic Cells", category: "Equilibrium & Acids", description: "Building an electrochemical cell and measuring its cell potential ($\text{E}_{cell}$)." },
            
            // Topics related to Quantum & Structure
            { id: 51, title: "Atomic Emission Spectra", category: "Quantum & Structure", description: "Observing the discrete lines of light emitted by elements when excited." },
            { id: 52, title: "Molecular Geometry (VSEPR)", category: "Quantum & Structure", description: "Building 3D models of molecules to predict bond angles and polarity." },
            { id: 53, title: "Half-Life of a Radioisotope", category: "Quantum & Structure", description: "Simulating radioactive decay to determine the half-life of an isotope." },
            { id: 54, title: "Covalent vs. Ionic Bonding", category: "Quantum & Structure", description: "Testing the conductivity, melting point, and solubility of various compounds." },
            { id: 55, title: "Periodic Trends Visualization", category: "Quantum & Structure", description: "Creating graphs of atomic radius, ionization energy, and electronegativity versus atomic number." },
            
            // Topics related to Organic & Polymers
            { id: 56, title: "Ester Synthesis", category: "Organic & Polymers", description: "Preparing a fragrant ester (e.g., methyl salicylate) from an alcohol and a carboxylic acid." },
            { id: 57, title: "Polymerization Reaction", category: "Organic & Polymers", description: "Synthesizing Nylon 6,6 or Slime through a condensation or addition reaction." },
            { id: 58, title: "Carbohydrate Testing", category: "Organic & Polymers", description: "Using Benedict's test and Iodine test to identify reducing sugars and starch." },
            { id: 59, title: "Saponification (Soap Making)", category: "Organic & Polymers", description: "Creating soap by hydrolyzing a fat or oil with a strong base." },
            { id: 60, title: "Alcohol Distillation", category: "Organic & Polymers", description: "Separating ethanol from a fermented mixture based on boiling point differences." },

            // Topics related to Advanced Techniques
            { id: 61, title: "Forensic Chromatography", category: "Advanced Techniques", description: "Analyzing ink or fiber samples to match suspects in a simulated crime scene." },
            { id: 62, title: "Advanced Mass Spectrometry Simulation", category: "Advanced Techniques", description: "Analyzing fragmented ion data to determine unknown molecular structures." },
            { id: 63, title: "Computational Chemistry Basics", category: "Advanced Techniques", description: "Using software to model and calculate molecular properties and reaction energies." },
            { id: 64, title: "Synthesis of Aspirin", category: "Advanced Techniques", description: "Multi-step organic synthesis lab involving recrystallization and purity testing." },
            { id: 65, title: "Thin Layer Chromatography (TLC)", category: "Advanced Techniques", description: "A rapid technique for monitoring reaction progress or analyzing mixtures." },

            // Topics related to Interdisciplinary
            { id: 66, title: "The Philosophy of Science", category: "Interdisciplinary", description: "Debating the demarcation problem and the role of falsifiability in scientific theories." },
            { id: 67, title: "Ethics of Chemical Synthesis", category: "Interdisciplinary", description: "Analyzing case studies on the responsible development of new materials." },
            { id: 68, title: "Thermodynamics and Cosmology", category: "Interdisciplinary", description: "Connecting the Second Law of Thermodynamics (Entropy) to the fate of the Universe." },
            { id: 69, title: "Quantum Mechanics and Epistemology", category: "Interdisciplinary", description: "Discussing how quantum uncertainty changes what we can 'know' about reality." },
            { id: 70, title: "Sustainable Chemistry (Green Chemistry)", category: "Interdisciplinary", description: "Designing a synthesis route that minimizes waste and energy usage." },
            
            // --- NEW TOPICS ADDED PER USER REQUEST ---
            { 
                id: 71, 
                title: "Periodic Table Elements", 
                category: "Atomic Structure", 
                description: "Exploring the organization, trends, and properties of elements using the Periodic Table.",
                youtubeLinks: [
                    { title: "The Periodic Table Explained", url: "http://www.youtube.com/watch?v=wXRHz5ZEIK0", channel: "Lincoln Learning Solutions" },
                    { title: "What is the Periodic Table? How are Elements Organized?", url: "http://www.youtube.com/watch?v=3NhBzKP03gY", channel: "Math and Science" },
                    { title: "Solving the puzzle of the periodic table - Eric Rosado", url: "http://www.youtube.com/watch?v=O-48znAg7VE", channel: "TED-Ed" },
                    { title: "How to find the Protons Neutrons and Electrons of an element on the Periodic table", url: "http://www.youtube.com/watch?v=yooYnW8uhHk", channel: "MooMooMath and Science" }
                ]
            },
            { id: 72, title: "Atomic Mass Determination", category: "Atomic Structure", description: "Calculating average atomic mass from isotope abundance data." },
            { id: 73, title: "Isotope Simulation Lab", category: "Atomic Structure", description: "Using statistical methods to understand different isotopes of an element." },
            // Total topics: 73
        ];
        
        // Extract unique categories for filtering
        const categories = [...new Set(labTopics.map(topic => topic.category))].sort();

        // Initial State
        let state = {
            activeTab: 'lab-topics',
            searchTerm: '',
            activeCategory: 'All',
            submissions: [ // Sample submissions for the Hub
                { name: "John Doe - Density Report", date: "2025-10-01", status: "Graded", grade: "A-", id: 1 },
                { name: "Jane Smith - Ester Synthesis Pre-Lab", date: "2025-10-15", status: "Pending Review", grade: null, id: 2 },
                { name: "S. Lee - Hess's Law Data Sheet", date: "2025-10-28", status: "Graded", grade: "B+", id: 3 },
            ], 
        };

        // --- CORE UTILITY FUNCTIONS ---

        // Custom, non-blocking message box (replaces alert())
        function showMessage(text, duration = 3000, isError = false) {
            const box = document.getElementById('message-box');
            const textElement = document.getElementById('message-text');
            textElement.textContent = text;
            
            box.classList.remove('hidden', 'opacity-0', 'bg-green-600', 'bg-red-600');
            box.classList.add(isError ? 'bg-red-600' : 'bg-green-600', 'fade-in');

            setTimeout(() => {
                box.classList.add('opacity-0');
                box.classList.remove('fade-in');
                setTimeout(() => box.classList.add('hidden'), 300); // Hide after transition
            }, duration);
        }

        // --- TAB MANAGEMENT ---
        function setActiveTab(targetId) {
            if (state.activeTab === targetId) return;

            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
                content.classList.remove('fade-in');
            });

            // Deactivate all buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('border-primary', 'text-primary', 'bg-tab-active-bg');
                button.classList.add('border-transparent', 'text-slate-400', 'hover:text-white', 'hover:border-slate-500');
            });

            // Simulate loading state before showing content
            const spinner = document.getElementById('loading-spinner');
            if (targetId === 'lab-topics') {
                 // If switching back to topics, ensure spinner is hidden
                 spinner.classList.add('hidden');
            } else {
                 spinner.classList.remove('hidden');
            }


            setTimeout(() => {
                spinner.classList.add('hidden');
                
                // Show target content and activate target button
                const targetContent = document.getElementById(targetId);
                const targetButton = document.querySelector(`.tab-button[data-target="${targetId}"]`);

                if (targetContent) {
                    targetContent.classList.remove('hidden');
                    targetContent.classList.add('fade-in');
                    state.activeTab = targetId;

                    if (targetButton) {
                        targetButton.classList.add('border-primary', 'text-primary', 'bg-tab-active-bg');
                        targetButton.classList.remove('border-transparent', 'text-slate-400', 'hover:text-white', 'hover:border-slate-500');
                    }

                    if (targetId === 'submission-hub') {
                        renderSubmissions();
                    }
                }
            }, 300); // Short delay for simulated loading effect
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Initial setup
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    setActiveTab(button.dataset.target);
                });
            });

            // Set the initial active tab
            setActiveTab(state.activeTab); 
            renderFilters();
            renderTopics();
            
            // Add search listener
            document.getElementById('search-input').addEventListener('input', handleSearch);
        });


        // --- TOPICS GRID RENDERING & FILTERING ---

        function renderFilters() {
            const filtersContainer = document.getElementById('category-filters');
            filtersContainer.innerHTML = ''; // Clear existing filters

            const allButton = createFilterButton('All', state.activeCategory === 'All');
            allButton.onclick = () => { setCategory('All'); };
            filtersContainer.appendChild(allButton);

            categories.forEach(category => {
                const isActive = state.activeCategory === category;
                const button = createFilterButton(category, isActive);
                button.onclick = () => { setCategory(category); };
                filtersContainer.appendChild(button);
            });
        }

        function createFilterButton(category, isActive) {
            const button = document.createElement('button');
            button.textContent = category;
            button.className = `px-4 py-1 text-sm font-medium rounded-full transition duration-150 ease-in-out whitespace-nowrap ${
                isActive
                ? 'bg-primary text-slate-900 shadow-md hover:bg-indigo-400'
                : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
            }`;
            return button;
        }

        function setCategory(category) {
            state.activeCategory = category;
            renderFilters(); // Re-render to update active state
            renderTopics();
        }
        
        function handleSearch(event) {
            state.searchTerm = event.target.value.toLowerCase().trim();
            renderTopics();
        }

        function renderTopics() {
            const grid = document.getElementById('topics-grid');
            const noResults = document.getElementById('no-results');
            grid.innerHTML = ''; // Clear existing content

            let filteredTopics = labTopics;

            // 1. Filter by Category
            if (state.activeCategory !== 'All') {
                filteredTopics = filteredTopics.filter(topic => topic.category === state.activeCategory);
            }

            // 2. Filter by Search Term
            if (state.searchTerm) {
                filteredTopics = filteredTopics.filter(topic =>
                    topic.title.toLowerCase().includes(state.searchTerm) ||
                    topic.description.toLowerCase().includes(state.searchTerm) ||
                    topic.category.toLowerCase().includes(state.searchTerm)
                );
            }

            if (filteredTopics.length === 0) {
                noResults.classList.remove('hidden');
                grid.classList.add('hidden');
                return;
            } else {
                noResults.classList.add('hidden');
                grid.classList.remove('hidden');
            }

            // 3. Render Cards
            filteredTopics.forEach((topic, index) => {
                const card = document.createElement('div');
                card.className = 'bg-card-dark rounded-xl p-6 border border-slate-700 hover:border-primary/50 card-shadow transition duration-300 cursor-pointer flex flex-col justify-between fade-in';
                card.style.animationDelay = `${index * 50}ms`; // Staggered animation
                card.innerHTML = `
                    <div>
                        <span class="text-sm font-mono text-primary bg-slate-700/50 rounded-full px-3 py-1 mb-3 inline-block">${topic.category}</span>
                        <h3 class="text-2xl font-bold text-white mb-2">${topic.title}</h3>
                        <p class="text-slate-400 mb-4">${topic.description}</p>
                    </div>
                    <div class="mt-4">
                        <button onclick="viewLesson(${topic.id}, event)" class="w-full px-4 py-2 bg-slate-700 text-white font-semibold rounded-lg hover:bg-primary hover:text-slate-900 transition duration-200">
                            Dive Deeper üöÄ
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }


        // --- LESSON MODAL LOGIC (THE FIX) ---
        
        // This function generates detailed mock content for the modal based on the topic.
        function generateLessonContent(topic) {
            // Generate some dynamic content based on the topic's category for realism
            const sections = {
                objectives: [
                    `Understand the fundamental principles of ${topic.category.toLowerCase()}.`,
                    `Accurately perform the core technique: ${topic.title}.`,
                    "Analyze collected data and calculate key values, such as " + (topic.category === "Stoichiometry" ? "percent yield" : "reaction rate") + ".",
                    "Identify sources of error and suggest improvements to the experimental design.",
                    "Relate the lab concept to real-world applications (e.g., industry, environment, daily life)."
                ],
                equipment: [
                    "Safety Goggles and Gloves (Mandatory)",
                    (topic.category === "Fundamentals" ? "Analytical Balance (0.001g precision)" : "Calorimeter / Hot Plate"),
                    "Beakers and graduated cylinders (25mL and 100mL)",
                    "Required Chemical: $\\text{H}_2\text{O}$ or $\\text{NaCl}$",
                    "A data sheet and calculator."
                ],
                procedure: `
                    <p><strong>1. Pre-Lab Preparation:</strong> Review safety protocols and the theoretical foundation for ${topic.title}. Ensure all glassware is clean and dry. Prepare all necessary solutions, paying close attention to concentration (molarity).</p>
                    <p><strong>2. Data Collection:</strong> Carefully measure and record initial data (e.g., initial mass, volume, temperature). Perform the main experimental step, ensuring variables are controlled. For example, if it's a **${topic.category}** lab, you must monitor the reaction until equilibrium is established or the reaction is complete.</p>
                    <p><strong>3. Reaction/Observation:</strong> Observe changes (color change, precipitate formation, temperature fluctuation) and record all final data points. For **${topic.title}**, this involves careful observation of the final state of the system.</p>
                    <p><strong>4. Post-Lab Cleanup:</strong> Safely dispose of all chemical waste as directed by the instructor. Clean all equipment and return it to the proper storage area.</p>
                `,
                key_equations: [
                    "The primary equation is: $\\text{Primary Law} = \\text{Variable}_1 \\cdot \\text{Variable}_2$ (For fundamentals)",
                    "For a **Stoichiometry** lab, the key is the mole ratio: $\\text{Moles}_A / \\text{Moles}_B = \\text{Coefficient}_A / \\text{Coefficient}_B$",
                    "For **Kinetics & Thermo**, you will use the heat equation: $q = m \\cdot c \\cdot \\Delta T$",
                    "For **Atomic Structure**, remember the key is electron configuration: $1s^2 2s^2 2p^6...$",
                    "Always calculate percent error: $\\text{Percent Error} = |\\text{Actual} - \\text{Theoretical}| / \\text{Theoretical} \\cdot 100$"
                ]
            };

            // Format the content into HTML
            let html = '';

            // Section 1: Objectives
            html += '<h4 class="text-2xl font-bold text-white mt-0 mb-3 border-b border-primary/50 pb-1">Learning Objectives</h4>';
            html += '<ul class="list-disc pl-5 space-y-2">';
            sections.objectives.forEach(item => {
                html += `<li class="text-slate-300">${item}</li>`;
            });
            html += '</ul>';

            // Section 2: Equipment
            html += '<h4 class="text-2xl font-bold text-white mt-6 mb-3 border-b border-primary/50 pb-1">Essential Equipment</h4>';
            html += '<ul class="list-disc pl-5 space-y-2">';
            sections.equipment.forEach(item => {
                html += `<li class="text-slate-300">${item}</li>`;
            });
            html += '</ul>';

            // Section 3: Procedure
            html += '<h4 class="text-2xl font-bold text-white mt-6 mb-3 border-b border-primary/50 pb-1">Step-by-Step Procedure</h4>';
            html += `<div class="space-y-4 text-slate-300">${sections.procedure}</div>`;
            
            // Section 4: Equations
            html += '<h4 class="text-2xl font-bold text-white mt-6 mb-3 border-b border-primary/50 pb-1">Key Equations (LaTeX Style)</h4>';
            html += '<div class="space-y-4 text-slate-300 p-4 bg-slate-800 rounded-lg shadow-inner">';
            sections.key_equations.forEach(item => {
                html += `<p class="font-mono text-lg italic text-yellow-300">${item}</p>`;
            });
            html += '</div>';

            // Section 5: Related Videos (NEW SECTION)
            if (topic.youtubeLinks && topic.youtubeLinks.length > 0) {
                html += '<h4 class="text-2xl font-bold text-white mt-8 mb-3 border-b border-delete-red/70 pb-1">Related YouTube Tutorials üé¨</h4>';
                html += '<p class="text-sm italic text-slate-400 mb-4">Click on a title to open the video in a new tab for deeper context.</p>';
                html += '<ul class="space-y-3">';
                topic.youtubeLinks.forEach(link => {
                    html += `
                        <li class="p-3 bg-slate-700/50 rounded-lg hover:bg-slate-600 transition duration-150">
                            <a href="${link.url}" target="_blank" class="text-primary hover:text-indigo-300 font-semibold flex items-center">
                                <svg class="w-5 h-5 mr-3 text-red-500" fill="currentColor" viewBox="0 0 24 24"><path d="M21.543 6.497A9.22 9.22 0 0017.923 2.8c-.808-.094-2.222-.162-4.22-.162h-2.906c-1.998 0-3.412.068-4.22.162A9.22 9.22 0 002.457 6.497 9.22 9.22 0 001.35 12c.107 2.112.162 3.447.162 4.072 0 .625-.055 1.96-.162 4.072a9.22 9.22 0 003.62 3.692c.808.094 2.222.162 4.22.162h2.906c1.998 0 3.412-.068 4.22-.162a9.22 9.22 0 003.62-3.692c.107-2.112.162-3.447.162-4.072 0-.625-.055-1.96-.162-4.072zM9.99 15.5V8.5L15.9 12l-5.91 3.5z"/></svg>
                                <span>${link.title}</span>
                            </a>
                            <span class="ml-8 text-xs text-slate-500 block">Channel: ${link.channel}</span>
                        </li>
                    `;
                });
                html += '</ul>';
            }

            return html;
        }

        function viewLesson(topicId, event) {
            // Stop the click from propagating to the parent card, preventing double-triggering if the button is clicked.
            if (event) {
                event.stopPropagation(); 
            }

            const topic = labTopics.find(t => t.id === topicId);
            if (!topic) {
                showMessage("Error: Topic data not found.", 4000, true);
                return;
            }

            const modal = document.getElementById('lesson-modal');
            const modalContent = document.getElementById('modal-content');
            const modalInnerContent = modal.querySelector('.modal-content-slide');
            
            // Set modal content details
            document.getElementById('modal-title').textContent = topic.title;
            document.getElementById('modal-category').textContent = topic.category;

            // Clear previous content and show a loading state
            modalContent.innerHTML = '<p class="text-center py-10 text-primary animate-pulse">Preparing lesson materials...</p>';

            // Show modal structure immediately and set initial transition classes
            modal.classList.remove('hidden');
            modal.classList.remove('opacity-0');
            modalInnerContent.classList.remove('translate-y-10', 'scale-95');
            
            // Simulate content loading delay (100ms) for better UX feel
            setTimeout(() => {
                const contentHtml = generateLessonContent(topic);
                modalContent.innerHTML = contentHtml;
                // Scroll content to top
                modalContent.scrollTop = 0;
            }, 100);
        }

        function closeModal() {
            const modal = document.getElementById('lesson-modal');
            const modalInnerContent = modal.querySelector('.modal-content-slide');

            // Start close animation
            modal.classList.add('opacity-0');
            modalInnerContent.classList.add('translate-y-10', 'scale-95');

            // Hide after transition finishes (300ms)
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }


        // --- SUBMISSION HUB LOGIC ---

        function displayFileName() {
            const input = document.getElementById('file-selector');
            const display = document.getElementById('selected-file-name');
            if (input.files.length > 0) {
                display.textContent = `Selected: ${input.files[0].name} (${(input.files[0].size / 1024).toFixed(2)} KB)`;
                display.classList.remove('text-slate-500');
                display.classList.add('text-green-400');
            } else {
                display.textContent = 'No file selected.';
                display.classList.remove('text-green-400');
                display.classList.add('text-slate-500');
            }
        }

        function simulateUpload() {
            const fileInput = document.getElementById('file-selector');
            const nameInput = document.getElementById('project-name-input');
            const fileNameDisplay = document.getElementById('selected-file-name');

            if (!nameInput.value.trim()) {
                showMessage("Please enter a name for your project.", 4000, true);
                nameInput.focus();
                return;
            }

            if (fileInput.files.length === 0) {
                showMessage("Please select a file to submit.", 4000, true);
                return;
            }

            // Simulate file reading and upload delay
            showMessage(`Uploading "${fileInput.files[0].name}"...`, 2000);

            setTimeout(() => {
                const newSubmission = {
                    name: nameInput.value.trim(),
                    date: new Date().toISOString().split('T')[0],
                    status: "Pending Review",
                    grade: null,
                    id: state.submissions.length + 1,
                };
                state.submissions.unshift(newSubmission); // Add to the start
                
                // Reset form inputs
                nameInput.value = '';
                fileInput.value = '';
                fileNameDisplay.textContent = 'No file selected.';
                fileNameDisplay.classList.remove('text-green-400');
                fileNameDisplay.classList.add('text-slate-500');

                renderSubmissions();
                showMessage(`Project "${newSubmission.name}" submitted successfully!`, 4000);
            }, 1500); // 1.5 second upload delay
        }

        function renderSubmissions() {
            const list = document.getElementById('submission-list');
            list.innerHTML = ''; // Clear list

            if (state.submissions.length === 0) {
                list.innerHTML = `<div class="text-center py-8 text-slate-500 border border-slate-700/50 rounded-lg">You have no submissions yet.</div>`;
                return;
            }

            state.submissions.forEach(submission => {
                let statusClass = '';
                let gradeDisplay = '';
                let actionButton = '';

                if (submission.status === 'Graded') {
                    statusClass = 'bg-green-500/20 text-green-300 border-green-500';
                    gradeDisplay = `<span class="font-bold text-green-400">${submission.grade}</span>`;
                    actionButton = `<button onclick="deleteSubmission(${submission.id})" class="text-red-400 hover:text-red-300 transition duration-150 p-1 rounded-full hover:bg-slate-700">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    </button>`;
                } else if (submission.status === 'Pending Review') {
                    statusClass = 'bg-yellow-500/20 text-yellow-300 border-yellow-500';
                    gradeDisplay = `<span class="font-bold text-yellow-400">N/A</span>`;
                    actionButton = `<button onclick="deleteSubmission(${submission.id})" class="text-red-400 hover:text-red-300 transition duration-150 p-1 rounded-full hover:bg-slate-700">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    </button>`;
                }

                const item = document.createElement('div');
                item.className = `p-5 bg-card-dark rounded-xl shadow-lg border-l-4 ${statusClass} flex justify-between items-center transition duration-200 hover:bg-slate-800`;
                item.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <p class="text-xl font-semibold text-white truncate">${submission.name}</p>
                        <div class="flex space-x-4 text-sm text-slate-400 mt-1">
                            <span>üìÖ ${submission.date}</span>
                            <span>|</span>
                            <span class="font-medium">Status: ${submission.status}</span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-6 ml-4">
                        <div class="text-right">
                            <p class="text-xs text-slate-500">Grade</p>
                            ${gradeDisplay}
                        </div>
                        ${actionButton}
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function deleteSubmission(id) {
            // Using a custom confirmation box pattern (since alert() is forbidden)
            const confirmation = window.confirm(`Are you sure you want to delete submission #${id}?`);
            if (confirmation) {
                state.submissions = state.submissions.filter(sub => sub.id !== id);
                renderSubmissions();
                showMessage(`Submission #${id} deleted.`, 3000, true);
            }
        }
    </script>
</body>
</html>
